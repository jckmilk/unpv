# 传输层：TCP、UDP和SCTP

* DUP是一个简单、不可靠的数据报协议
* TCP是一个复杂、可靠的字节流协议
  

图TCP/IP协议概况

## 用户数据报协议（UDP）

应用进程往一个UDP套接字写入一个信息，然后封装成UDP数据报，随后封装成IP数据报，UDP不保证是否到达，不保证先后顺序，不能保证每个数据报只到达一次。

每个数据报都有一个长度，如果一个数据报正确到达目的地，该数据报的长度随数据传到应用进程。

UDP是无连接的，客户和服务器之间不存在长期关系。

## 传输控制协议（TCP）
* 建立连接
* 提供可靠性
* TCP含有计算往返时间的算法（RTT)
* 保证有序，TCP为每个字节的数据提供编号。
* 流量控制，总是告诉对端它一次能够从对端接收多少字节的数据，成为通知窗口，该窗口指示接收缓冲区的可用空间大小。

## TCP连接的建立和终止

图TCP 三次握手

1. 服务器准备好外来连接，通常调用socket、bind、listen函数，成为被动打开
2. 客户端执行connect发起主动打开 TCP发送一个SYN分节，服务器确认分节，同时发送一个SYN分节。
3. 客户端发送ack

## TCP选项
* MSS选项，发送SYN的TCP一端使用此选项通知对端最大分节大小
* 窗口规模，TCP连接的任何一端告知对端的最大窗口大小为65535
* 时间戳。

## TCP连接终止
* 某应用执行close，称该端主动关闭，tcp发送一个FIN分节。
* 接收端执行被动关闭，同时此FIN接收作为一个文件结束符传递到接收端的应用基层进程。
* 一段时间后，接收到这个文件结束符的应用进程调用close，导致tcp发送一个FIN。
* 接收端对FIN进行确认。
  

## TCP状态连接图
观察分组 图tcp连接的分组交换

## time_wait

time_wait持续的时间为2MSL(最长分节生命期）

迷途分组

time_wait存在的两个理由：
* 可靠的实现tcp全双工连接的终止
* 允许老的重复分节在网络中消逝
  
第一个理由为假设最后一个ack丢失了，服务器将重复发送最终的那个FIN，客户必须维护状态信息，以允许它重复发送ack，要是客户不维护，它将响应RST，该分节被服务器解释为错误。**必须正确处理终止的四个分节中任何一个丢失的情况**

第二个理由为防止某个连接的老的重复分组被误解为新的连接的字节序列：老的序列只可能是ack和FIN字节。画图理解


## 端口号
端口号为16为整数
* 众所周知的端口号0-1023
* 已登记的端口1024~49151
* 临时端口 49152~65535
* unix系统有保留端口，小于1024的端口，只有特权用户才可以使用

## tcp端口号与并发服务器

tcp无法仅通过查看目的端口号来分离外来的节点到不同的端点，它必须查看套接字对的所有四个元素才能确定哪个端点解释奇偶某个分节的到达。

## 缓冲区的大小及限制

